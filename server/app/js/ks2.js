"use strict";function pad(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n}angular.module("KSMapper",["ionic","config","KSMapper.controllers","KSMapper.services","leaflet-directive","ngStorage","ngOrderObjectBy"]).run(["$ionicPlatform","$lookup",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,t,n){n.tabs.position("bottom"),e.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginController"}).state("map",{url:"/map/:slot",cache:!1,templateUrl:"templates/map.html",controller:"MapController"}).state("main",{url:"/main","abstract":!0,templateUrl:"templates/main.html"}).state("main.games",{url:"/games",views:{"main-games":{templateUrl:"templates/games.html",controller:"mainController"}}}).state("main.scenarios",{url:"/scenarios",cache:!1,views:{"main-scenarios":{templateUrl:"templates/scenarios.html",controller:"scenariosController"}}}).state("main.settings",{url:"/settings",views:{"main-settings":{templateUrl:"templates/settings.html",controller:"settingsController"}}}).state("main.manuals",{url:"/manuals",views:{"main-manuals":{templateUrl:"templates/manuals.html",controller:"manualsController"}}}).state("main.manuals.scale",{url:"/scale",views:{manualContent:{templateUrl:"manuals/scale.html"}}}).state("main.logout",{url:"/logout",views:{"main-logout":{templateUrl:"templates/logout.html",controller:"logoutController"}}}),t.otherwise("/main/games")}]),angular.module("KSMapper.controllers",["ionic"]).controller("LoginController",["$scope","$state","$tabs","$token","$login","$localStorage",function(e,t,n,a,o,i){i.$default({user:{},token:""}),angular.extend(e,{failedPasswd:!1,user:i.user,errorCondition:"",login:function(){n.select("welcome",1)},splash:function(){n.select("welcome",0)},account:function(){n.select("welcome",2)}}),a.check(i.token).then(function(){e.errorCondition="",e.failedPasswd=!1,t.go("main.games")}),e.logIn=function(a){e.errorCondition="Logging in ....",o.login(a.email,a.password).then(function(){e.errorCondition="",e.failedPasswd=!1,t.go("main.games")},function(t){404==t?(e.account(),n.select("welcome",2)):e.failedPasswd=!0})},e.register=function(t){o.register(t).then(function(t){e.errorCondition=t+"... Please check your email to validate your account",e.login()},function(t){e.errorCondition=t})},e.forgotPassword=function(t){e.failedPasswd=!1,o.forgot(t.email).then(function(t){e.errorCondition=t})}}]).controller("MapController",["$scope","$state","leafletData","leafletEvents","$localStorage","$token","$scenario","$layers","$icons","$slots","$armies","$stateParams","$battleScenes","$tabs","$ionicScrollDelegate","$timeout","$lookup","$ionicModal","$ionicActionSheet","$ionicPopup",function(e,t,n,a,o,i,r,s,l,c,u,g,h,d,f,m,p,v,b,k){switch(i.check(),p.init(),n.getMap().then(function(t){t.options.maxZoom=11,t.options.minZoom=7,e.map=t,void 0===e.scale&&(e.scale=L.control.scale(),e.scale.addTo(t))}),r.initScenario(),m(function(){d.select("map",2)},300),angular.extend(e,{lookup:p,isLoaded:!1,mappingMode:!0,armies:u,color:"Blue",showImageSelect:!1,showInfPanel:!1,showCavPanel:!1,showGunPanel:!1,showCmdPanel:!1,allowedUnitTypes:[],edittingSubunit:null,battleScenes:h,icons:l,data:{showReorder:!1,showDelete:!1,showUnitHeader:!1},events:{map:{enable:["click","drag","contextmenu","dblclick","load"],logic:"emit"},marker:{enable:["click","drag","contextmenu","dblclick"],logic:"emit"},path:{enable:["click"],logic:"emit"}},slots:c,file:r.file,layers:{baselayers:{watercolor:s.baselayers.watercolor},overlays:{labels:s.overlays.labels,objective:{type:"group",name:"Objectives",visible:!0,zIndex:101},strategic:{type:"group",name:"Strategic",visible:!0,zIndex:102},tactical:{type:"group",name:"Tactical",visible:!1,zIndex:103}}},defaults:{zoomControlPosition:"topleft"},center:{stratCenter:{lat:50.92,lng:11.58,zoom:8},tacCenter:{lat:50.92,lng:11.58,zoom:8},mapCenter:{lat:50.92,lng:11.58,zoom:8}},usingSlot:0,zoomed:!1,controlstate:1,controlFocus:!1,unit:null,subSelected:null,maxbounds:{},markers:r.markers,paths:r.paths,scenario:r,showUnit:!1,canReturn:!1}),c.load(),e.hasLocalStore=function(){return angular.isDefined(o.scenario)},e.backBtn=function(n){switch(n){case 1:if(e.canReturn)switch(g.slot){case"new":case"local":angular.equals(r.markers,{})||r.saveToLocalStorage({file:e.file,center:e.center.stratCenter}),t.go("main.scenarios",{page:"scenarios"});break;default:if(r.changed){d.select("map",2);var a=-1;angular.forEach(e.slots.slots,function(t,n){t.Slot==e.usingSlot&&(a=n)}),b.show({titleText:"So you want to Quit ?",buttons:[{text:"Save Changes and Exit"}],destructiveText:"Quit without Saving",cancelText:"Cancel - Stay in the Editor",androidEnableCancelButton:!0,cancel:function(){},buttonClicked:function(){e.commitSave(e.usingSlot,e.file),t.go("main.scenarios",{page:"scenarios"})},destructiveButtonClicked:function(){t.go("main.scenarios",{page:"scenarios"})}})}else t.go("main.scenarios",{page:"scenarios"});c.load()}break;case 2:e.canReturn=!0}},e.saveMap=function(){if(0===e.usingSlot){var t=0;angular.forEach(e.slots.slots,function(e){e.Slot>t&&(t=e.Slot)}),e.usingSlot=t+1}e.commitSave(e.usingSlot,e.file),r.changed=!1,e.onEditMap(),d.select("map",2)},e.onEditMap=function(){e.mappingMode=!0,e.topLevelControls(),e.isLoaded=!0,e.controlstate=0},e.onRoster=function(){e.mappingMode=!1,e.isLoaded=!1,e.controlstate=0},e.mainMenu=function(){e.isLoaded=!1,t.go("main.scenarios")},e.getRatingDesc=function(e){return"undefined"!=typeof e?p.rating[e].name:void 0},e.objectiveMenu=function(){e.mode="Objective",r.objMode("New","GoldObjective"),e.layers.overlays.objective.visible=!0,e.layers.overlays.strategic.visible=!1,e.layers.overlays.tactical.visible=!1,e.showUnit=!1},e.objMode=function(e,t){r.objMode(e,t)},e.unitControls=function(t){e.mode="Subunits",e.level="HQ",e.color=t,r.setSelection(t,"HQ"),e.layers.overlays.objective.visible=!1,e.layers.overlays.strategic.visible=!0,e.layers.overlays.tactical.visible=e.zoomed},e.topLevelControls=function(){e.mode="Move",r.clearSelection(),e.closeUnitPopup(),e.closeObjectivePopup(),e.layers.overlays.objective.visible=!1,e.layers.overlays.strategic.visible=!0,e.layers.overlays.tactical.visible=e.zoomed},e.popupUnit=function(t){e.unit=t,e.color=t.color,e.showUnit=!0,e.showObjectiveDetails=!1,e.layers.overlays.objective.visible=!1,e.layers.overlays.strategic.visible=!0,e.layers.overlays.tactical.visible=e.zoomed,r.getParentDistance(e.unit),e.controlstate=0,e.mode="Subunits"},e.popupObjective=function(t){e.objective=t,e.showObjectiveDetails=!0,e.showUnit=!1,e.layers.overlays.objective.visible=!0,e.layers.overlays.strategic.visible=!1,e.layers.overlays.tactical.visible=!1,e.controlstate=0},e.closeUnitPopup=function(){e.showUnit=!1},e.closeObjectivePopup=function(){e.showObjectiveDetails=!1},e.showObjectives=function(){return e.mappingMode&&"Objective"==e.mode},e.showSubunits=function(){return e.mappingMode&&"Subunits"==e.mode},e.showToplevelControls=function(){switch(e.mode){case"Subunits":case"Objective":return!1}return e.mappingMode},e.showMapControls=function(){return e.controlstate>0},e.showFileControls=function(){return 1==e.controlstate},e.showSlotControls=function(){return e.controlstate>1},e.showLoadControls=function(){return 2==e.controlstate},e.showSaveControls=function(){return 3==e.controlstate},e.controlsCloseMainMenu=function(){e.controlstate=0},e.controlsMainMenu=function(){e.controlstate=1,e.closeObjectivePopup(),e.closeUnitPopup()},e.controlsLoadMenu=function(){c.load(),e.controlstate=2},e.controlsSaveMenu=function(){c.load(),e.controlstate=3},e.selectUnit=function(t){e.level=t,r.setSelection(e.color,t)},e.clickControls=function(){e.controlFocus=!0},e.duplicate=function(){e.file.name="copy of "+e.file.name,e.usingSlot=0},e.$on("leafletDirectiveMap.load",function(){m(function(){e.isLoaded=!0},100)}),e.$on("leafletDirectiveMap.drag",function(){r.changed=!0}),e.$on("leafletDirectiveMap.zoomlevelschange",function(){}),e.$on("leafletDirectiveMap.contextmenu",function(t,n){e.zoomed&&e.toggleZoom(t,n)}),e.$on("leafletDirectiveMarker.dragstart",function(t,n){e._dragStart=n.leafletEvent.target._latlng,e._dragFrom=e._dragStart,e.markerClick(t,n)}),e.$on("leafletDirectiveMarker.drag",function(t,n){var a=e.markers[n.markerName];if("U"==a.type&&(r.dragUnit(a,n.leafletEvent.target._latlng),!e.zoomed&&"Corps"==a.lvl)){var o=n.leafletEvent.target._latlng,i=o.lat-e._dragFrom.lat,s=o.lng-e._dragFrom.lng;e._dragFrom=o,angular.forEach(e.markers,function(e){e.parent==a.id&&(e.lat+=i,e.lng+=s)})}"O"==a.type&&r.dragObjective(a,n.leafletEvent.target._latlng),r.changed=!0}),e.$on("leafletDirectiveMarker.dragend",function(t,n){e.markers[n.markerName];e._dragEnd=n.leafletEvent.target._latlng,e.markerClick(t,n)}),e.$on("leafletDirectivePath.click",function(t,n){var a=e.findObjPath(n.leafletEvent.latlng);if(void 0!==a){console.log("clicked on",a);{b.show({buttons:[{text:"Share"},{text:"Move"}],destructiveText:"Delete Connection",titleText:"Objective Connection",cancelText:"Cancel",androidEnableCancelButton:!0,cancel:function(){console.log("clicked on the cancel option")},buttonClicked:function(){return!0},destructiveButtonClicked:function(){return!0}})}}}),e.findObjPath=function(t){console.log("Finding ObjPath closest to",t);var n,a=L.latLng(t);return console.log(e.paths.objPaths),angular.forEach(e.paths.objPaths.latlngs,function(e,t){console.log(t,e);var o=L.latLng(e[0]),i=L.latLng(e[1]),r=o.distanceTo(i),s=o.distanceTo(a)+a.distanceTo(i)-r;10>s&&.2>s/r?(console.log("Looks like",e[0].name," - ",e[1].name," is the correct line",s,e),n=e):console.log("It aint",e[0].name," - ",e[1].name,s)}),n},e.getToggleDesc=function(t){if(t){if(e.zoomed)switch(t.lvl){case"HQ":return"HQ Strategic View";default:return"Corps Strategic View"}return t.lvl+" Tactical View"}},e.getToggleIcon=function(){return e.zoomed?"ion-ios-undo":"ion-ios-search"},e.toggleUnitZoom=function(t){if(e.zoomed)switch(t.lvl){case"HQ":case"Corps":break;default:var n=e.markers[t.parent];e.markerClick(null,{markerName:t.parent,leafletEvent:{latlng:{lat:n.lat,lng:n.lng}}})}else e.center.mapCenter.lat=t.lat,e.center.mapCenter.lng=t.lng;e.toggleZoom()},e.toggleZoom=function(t,n){if(e.zoomed)delete e.layers.baselayers.topographic,e.layers.baselayers.watercolor=s.baselayers.watercolor,e.layers.overlays.labels.visible=!0,e.layers.overlays.tactical.visible=!1,e.map.options.maxZoom=12,e.map.options.minZoom=7,angular.copy(e.center.stratCenter,e.center.mapCenter),e.zoomed=!1,e.maxbounds={},r.setSelection(e.color,"Corps");else{var a=0,o=0;n?(a=n.leafletEvent.latlng.lat,o=n.leafletEvent.latlng.lng):(a=e.center.mapCenter.lat,o=e.center.mapCenter.lng),e.map.options.maxZoom=15,e.map.options.minZoom=13,angular.copy(e.center.mapCenter,e.center.stratCenter),e.center.mapCenter.lat=a,e.center.mapCenter.lng=o,e.center.mapCenter.zoom=12,delete e.layers.baselayers.watercolor,e.layers.overlays.labels.visible=!1,e.layers.overlays.tactical.visible=!0,e.layers.baselayers.topographic=s.baselayers.topographic,e.zoomed=!0,r.setSelection(e.color,"Div"),e.maxbounds={northEast:{lat:a+.1,lng:o+.1},southWest:{lat:a-.1,lng:o-.1}}}},e.$on("leafletDirectiveMap.zoomend",function(){}),e.$on("leafletDirectiveMap.dblclick",function(t,n){var a=n.leafletEvent.latlng.lat,o=n.leafletEvent.latlng.lng;e.center.mapCenter.lat=a,e.center.mapCenter.lng=o,e.center.mapCenter.zoom++,e.center.mapCenter.zoom>e.map.options.maxZoom&&(e.center.mapCenter.zoom=e.map.options.maxZoom)}),e.closeHQModal=function(t){e.addedHQ.nation=t,e.newHQmodal.hide(),e.popupUnit(e.addedHQ)},e.$on("leafletDirectiveMap.click",function(t,n){var a=n.leafletEvent.latlng.lat,o=n.leafletEvent.latlng.lng;if("Objective"==e.mode)switch(r.oMode){case"New":e.popupObjective(r.addObjective(r.oColor,a,o))}else"HQ"==r.level?(e.newLat=a,e.newLng=o,e.addedHQ=r.addUnit(r.color,r.level,e.newLat,e.newLng),v.fromTemplateUrl("templates/new-hq.html",{scope:e,animation:"fade-in"}).then(function(t){e.newHQmodal=t,t.show()})):e.popupUnit(r.addUnit(r.color,r.level,a,o))}),e.$on("leafletDirectiveMarker.click",function(t,n){e.markerClick(t,n)}),e.$on("leafletDirectiveMarker.contextmenu",function(t,n){e.toggleZoom(t,n),e.markerClick(t,n)}),e.$on("leafletDirectiveMarker.dblclick",function(t,n){e.toggleZoom(t,n),e.markerClick(t,n)}),e.markerClick=function(t,n){var a=e.markers[n.markerName];if(a)switch(a.color){case"GoldObjective":case"BlueObjective":case"RedObjective":"Connect"!=r.oMode&&e.popupObjective(a),r.click(a);break;default:if(void 0!==n.leafletEvent.latlng){var o=n.leafletEvent.latlng.lat,i=n.leafletEvent.latlng.lng;e.center.mapCenter.lat=o,e.center.mapCenter.lng=i}r.click(a),e.popupUnit(a)}},e.changeFlag=function(){},e.barClass=function(){var e=r.getArmy();return e?"bar bar-"+e["class"]:"bar bar-positive"},e.saveToSlot=function(t){if(1>t||t>e.slots.length)return void console.log("Invalid slot number",t);if(e.file.name&&e.file.season&&e.file.year&&e.file.period)switch(e.slots[t-1].Type){case"":e.commitSave(t,e.file);break;default:k.confirm({title:"Overwrite Slot",subTitle:e.slots[t-1].Type,template:e.slots[t-1].Name}).then(function(n){n&&e.commitSave(t,e.file)})}else k.alert({title:"Please fill in the details of your scenario, including :<ul><li>Name<li>Year<li>Season</ul>"})},e.commitSave=function(t,n){var a=e.center.mapCenter;e.zoomed&&(a=e.center.stratCenter),r.save(t,{file:n,center:a}).then(function(){c.load()}),e.usingSlot,e.usingSlot=t},e.loadFromSlot=function(t){r.load(t).then(function(n){p.getForces(n.Period),e.zoomed&&e.toggleZoom(),e.layers.overlays.objective.visible=!0,e.layers.overlays.strategic.visible=!0,e.layers.overlays.tactical.visible=!1,e.layers.overlays.labels.visible=!0,e.center.mapCenter.lat=n.Lat,e.center.mapCenter.lng=n.Lng,e.center.mapCenter.zoom=n.Zoom,e.markers=n.markers,e.paths=n.paths,e.usingSlot=t,r.changed=!1,e.topLevelControls()})},e.colorChange=function(e){e.icon=l[e.color]},e.gunChange=function(e){r._matchRangeMarker(e),r.nextGun=e.guns},e.selectCav=function(e){r.nextCav=e.cav},e.deleteObjective=function(e){k.confirm({title:"Delete This Objective ?",subTitle:e.name}).then(function(t){t&&r.deleteObj(e)})},e.quitEditor=function(){e.usingSlot?k.confirm({title:"Delete This Scenario ?"}).then(function(n){n&&(r.deleteSlot(e.usingSlot),t.go("main.scenarios",{page:"scenarios"}))}):t.go("main.scenarios",{page:"scenarios"})},e.disconnectObjective=function(e){k.confirm({title:"Disconnect this Objective ?",subTitle:e.name}).then(function(t){t&&r.disconnectObjective(e)})},e.deleteUnit=function(t){k.confirm({title:"Delete this Unit ?",subTitle:t.label.message}).then(function(n){if(n&&(r.deleteUnit(t),e.closeUnitPopup(),e.zoomed))switch(t.lvl){case"HQ":case"Corps":e.toggleZoom()}})},e.selectImage=function(){e.showImageSelect=!e.showImageSelect},e.closeSelectImage=function(){e.showImageSelect=!1},e.imageSelected=function(t){e.file.image=h[t],e.showImageSelect=!1,r.changed=!0},e.getHQList=function(e){var t=[];return angular.forEach(r.units[e],function(n){"HQ"==n.lvl&&n.color==e&&t.push(n)}),t},e.getCorpsList=function(e,t){var n=[];return angular.forEach(r.units[e],function(e){"Corps"==e.lvl&&e.parent==t&&n.push(e)}),n},e.getSubunitList=function(e,t){var n=[];return angular.forEach(r.units[e],function(e){e.parent==t&&n.push(e)}),n},e.roster=function(t,n){switch(e.unit=n,t){case"HQ":r.setSelection(n.color,"HQ"),d.select("map",3);break;case"Corps":r.setSelection(n.color,"Corps"),d.select("map",4);break;default:r.setSelection(n.color,n.lvl),d.select("map",5),m(function(){f.$getByHandle("subUnitScroll").scrollTop(!0)},50)}},e.scrollSubsToTop=function(){m(function(){f.$getByHandle("subUnitScroll").scrollTop(!0)},50)},e.addSubUnit=function(t,n){var a={};switch(n){case"X":angular.extend(a,{Type:"X",Name:"Commander",Attr:1});break;case"I":var o=e.file.period,i=0;if(angular.forEach(p.forces,function(e){e.Period===o&&e.Nation===t.nation&&(i=e.Inf[0])}),i){{p.inf[i]}angular.extend(a,{Type:"I",Name:"Infantry Bn",Rating:5,Size:700,Attr:i})}break;case"C":angular.extend(a,{Type:"C",Name:"Cavalry",Rating:6,Size:400,Attr:3});break;case"A":angular.extend(a,{Type:"A",Name:"Field Battery",Rating:5,Size:6,Attr:2})}t.sub.push(a),f.$getByHandle("subUnitScroll").scrollTo(0,150*t.sub.length-300,!0)},e.adjustUnitSize=function(t,n,a){switch(e.subSelected=a,t.Type){case"I":case"C":t.Size+=25*n;break;case"A":t.Size+=n}},e.adjustUnitRating=function(t,n,a){switch(e.subSelected=a,t.Type){case"I":case"C":case"A":t.Rating+=n}t.Rating<1&&(t.Rating=1),t.Rating>11&&(t.Rating=11)},e.adjustUnitAttr=function(t,n,a){var o=e.file.period;if(e.showInfPanel)return void(e.showInfPanel=!1);if(e.showCavPanel)return void(e.showCavPanel=!1);if(e.showGunPanel)return void(e.showGunPanel=!1);if(e.showCmdPanel)return void(e.showCmdPanel=!1);switch(e.edittingSubunit=n,e.showInfPanel=!1,e.showCavPanel=!1,e.showGunPanel=!1,e.showCmdPanel=!1,e.subSelected=a,n.Type){case"X":e.showCmdPanel=!0;break;case"I":angular.forEach(p.forces,function(n){n.Period===o&&n.Nation===t.nation&&(e.allowedUnitTypes=n.Inf)}),e.showInfPanel=!0;break;case"C":e.showCavPanel=!0;break;case"A":e.showGunPanel=!0}},e.closeUnitTypePanel=function(){e.showInfPanel=!1,e.showCavPanel=!1,e.showGunPanel=!1,e.showCmdPanel=!1},e.getInfantryImage=function(t){return"troops/"+e.lookup.inf[t].image+".jpg"},e.getInfantryBases=function(t){var n="",a=e.lookup.inf[t];return n=""+a.bases[0]+"x Bases",a.bases[2]&&(n+=" (incl "+a.bases[2]+" Elite)"),n+=" in "+a.ranks+" ranks",a.bases[1]>0&&(a.bases[0]>0?n+=" + "+a.bases[1]+" Sk":n="1 Base -> "+a.bases[1]+" Skirmishers"),n},e.unitAttrSelected=function(t){e.edittingSubunit.Attr=parseInt(t),e.closeUnitTypePanel(),e.edittingSubunit=null},e.infChooserClass=function(t){return null!==e.edittingSubunit&&e.allowedUnitTypes[t]===e.edittingSubunit.Attr?"item-calm":void 0},e.getChooserClass=function(t){return null!==e.edittingSubunit&&parseInt(t)===e.edittingSubunit.Attr?"item-calm":void 0},e.seasonImage=function(e){return"images/"+angular.lowercase(e)+".jpg"},e.describeSubUnit=function(e,t){var n=p.rating[e.Rating],a=0;switch(e.Type){case"X":var o=p.cmd[e.Attr];return t?o.name:"";case"I":var i=p.inf[e.Attr],r=75*i.ranks,s=Math.round(r/2),l="";if(e.Rating>=i.fire[0]&&(l="+Musketry"),e.Rating<=i.fire[1]&&(l="-Musketry"),e.Rating>=i.bayonet[0]&&(l+=" +Bayonet"),e.Rating<=i.bayonet[1]&&(l+=" -Bayonet"),i.shock&&(l+=" ShockTroops"),""!==l&&(l=" [ "+l+" ]"),t){var c="";if(i.bases[0]>0){var u=Math.round((e.Size+s)/r);a=i.bases[0],a>u&&(a=u),c+=a+"x Line Bases"}if(i.bases[2]>0&&(c+=", (incl "+i.bases[2]+"x Elite)"),i.bases[1]>0){var g=Math.round(e.Size/75);if(a=i.bases[1],a>g&&(a=g),i.bases[0]>0)c+=" + "+a+" attached Sk";else{var h=Math.round(e.Size/75),d=i.bases[1];d>h&&(d=h),c+="1 Base -> "+d+" Sk"}i.rifle&&(c+=" (rifles)")}return i.bases[3]>0&&e.Rating>4&&(c+=" ... can use 3rd Rank as Skirmishers"),"("+e.Size+" men as "+i.desc+" in "+i.ranks+" ranks) - "+c}return n.name+" Infantry - "+i.name+l;case"C":if(!t)return a=Math.round((e.Size+37)/75),n.name+" Cavalry - ("+e.Size+" horse) - "+a+" bases - "+p.cav[e.Attr].name;break;case"A":if(!t){var f=Math.round(e.Size/2);return n.name+" Artillery - ("+e.Size+" guns) - "+f+" Gun Models - "+p.gun[e.Attr].name+" "+p.gun[e.Attr].desc}break;default:return"Unknown "+e.type}return""},e.subUnitClass=function(t,n){var a="";switch(n===e.subSelected&&(a="item-stable "),t.Type){case"X":return a+"item-divider item-avatar";case"I":case"C":case"A":return a+"item-avatar";default:return""}},e.subUnitAvatar=function(e){switch(e.Type){case"X":return"images/avatar-general.jpg";case"I":return"images/avatar-infantry.jpg";case"C":return"images/avatar-cavalry.jpg";case"A":return"images/avatar-artillery.jpg";default:return""}},e.delSubUnit=function(t,n){t.sub.splice(n,1),e.subSelected=null},e.editSubUnit=function(t,n){e.subSelected=n},e.reorderUnit=function(t,n,a,o){t.sub.splice(a,1),t.sub.splice(a+o,0,n),e.subSelected=a+o,f.$getByHandle("subUnitScroll").scrollBy(0,150*o-150,!0)},e.unitToNextBde=function(t,n,a){e.subSelected=a;for(var o=a;o<t.sub.length;o++)if("X"==t.sub[o].Type)return t.sub.splice(a,1),t.sub.splice(o,0,n),e.subSelected=o,void f.$getByHandle("subUnitScroll").scrollTo(0,150*o-150,!0)},e.unitToPrevBde=function(t,n,a){e.subSelected=a;for(var o=a;o>0;o--)if("X"==t.sub[o].Type){if(0===o)return;return t.sub.splice(a,1),t.sub.splice(o,0,n),e.subSelected=o,void f.$getByHandle("subUnitScroll").scrollTo(0,150*o-150,!0)}},e.usingSlot=0,g.slot){case"new":if(void 0===r.file.period||""===r.file.period)t.go("main.scenarios",{page:"scenarios"});else{var y=p.getPeriod(r.file.period);e.center.mapCenter.lat=y.lat,e.center.mapCenter.lng=y.lng,e.center.mapCenter.zoom=8,e.layers.overlays.objective.visible=!0,e.layers.overlays.strategic.visible=!0,e.layers.overlays.tactical.visible=!1,e.layers.overlays.labels.visible=!0,e.saveMap()}break;case"local":var S=r.loadFromLocalStorage();null!==S&&(e.center.mapCenter.lat=S.Lat,e.center.mapCenter.lng=S.Lng,e.center.mapCenter.zoom=S.Zoom,e.markers=S.markers,e.paths=S.paths);break;default:e.usingSlot=parseInt(g.slot),e.loadFromSlot(e.usingSlot)}}]).controller("mainController",["$scope","$token","$login",function(e,t,n){t.check(),console.log(n),e.login=n}]).controller("gamesController",["$scope","$token",function(e,t){t.check()}]).controller("manualsController",["$scope","$token",function(e,t){t.check()}]).controller("scenariosController",["$scope","$slots","$state","$token","$tabs","$timeout","$localStorage","$ionicModal","$scenario","$lookup","$login",function(e,t,n,a,o,i,r,s,l,c,u){a.check(),c.init(),u.ensureLoggedin(),s.fromTemplateUrl("templates/new-scenario.html",{scope:e,animation:"fade-in"}).then(function(t){e.modal=t}),angular.extend(e,{lookup:c,login:u,slots:t,errorMsg:"",seasons:[{name:"Spring",selected:!0,image:"images/spring.jpg"},{name:"Summer",selected:!1,image:"images/summer.jpg"},{name:"Autumn",selected:!1,image:"images/autumn.jpg"},{name:"Winter",selected:!1,image:"images/winter.jpg"}],file:{name:"",season:"",year:"",image:"",period:""},loadFromSlot:function(e){n.go("map",{slot:e})},hasLocalStore:function(){return angular.isDefined(r.scenario)},newMap:function(){e.modal.show()},continueMap:function(){n.go("map",{slot:"local"})},closeCreateModal:function(){this.errorMsg="";var t=this.file;""!==t.name&&""!==t.season&&""!==t.year&&""!==t.period?(e.modal.hide(),l.createScenario(this.file),c.getForces(this.file.period),n.go("map",{slot:"new"})):this.errorMsg="Please select a  Theatre / Period, and enter : Name, Year & Season"}}),e.$on("$destroy",function(){e.modal.remove()}),t.load()}]).controller("settingsController",["$scope","$token","$login","$localStorage","$ionicPopup",function(e,t,n,a,o){t.check(),angular.extend(e,{user:a.user,scenarios:[],slots:[],updateUser:function(e){n.update(e).then(function(){o.alert({title:"Account Details Updated"})})}})}]).controller("logoutController",["$scope","$token","$localStorage","$state","$ionicPopup",function(e,t,n,a,o){t.check(),angular.extend(e,{logout:function(){delete n.token,o.alert({title:"You have now logged out !"}).then(function(){a.go("login")})}})}]),angular.module("KSMapper.services",[]).factory("$token",["$http","$log","$q","$state","$localStorage","ENV",function(e,t,n,a,o,i){return console.log("token init",i.name,i.SERVER),{check:function(){var r=o.token,s=n.defer();return angular.isDefined(r)&&null!==r?e.post(i.SERVER+"/token",{token:r}).success(function(e,t){s.resolve(t)}).error(function(e,n){t.error("Token failed",e,n),delete o.token,delete o.lookups,s.reject(n),a.go("login")}):(s.reject(404),a.go("login")),s.promise},get:function(){return o.token}}}]).factory("$login",["$http","$log","$q","$token","$localStorage","$lookup","ENV",function(e,t,n,a,o,i,r){return{loggedin:!1,admin:!1,username:"",credit:0,scenarios:0,ensureLoggedin:function(){this.loggedin||this.login(o.user.email,o.user.password)},login:function(a,s){var l=this,c=n.defer();return e.post(r.SERVER+"/login",{email:a,password:s}).success(function(e,t){o.token=e.TokenString;var n=e.Lookups;i.loadData(n),l.username=e.Username,l.credit=e.Credit,l.admin=e.Admin,l.scenarios=e.Scenarios,l.loggedin=!0,c.resolve(t)}).error(function(e,n){t.error("login error",e,n),delete o.token,c.reject(n)}),c.promise},register:function(t){var a=n.defer();return e.post(r.SERVER+"/register",t).success(function(e){o.user=t,a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},update:function(t){var a=n.defer();return e.post(r.SERVER+"/updateuser",{token:o.token,user:t}).success(function(e){o.user=t,a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},forgot:function(t){var a=n.defer();return e.post(r.SERVER+"/forgot",{Email:t}).success(function(e){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise}}}]).factory("$slots",["$log","$token","$q","$http","ENV",function(e,t,n,a,o){return{slots:[],load:function(){var e=this;a.post(o.SERVER+"/scenarios",{token:t.get()}).success(function(t){e.slots=t})}}}]).factory("$armies",function(){return[{name:"Blue",rgb:"#33f","class":"positive"},{name:"Red",rgb:"#f33","class":"assertive"},{name:"Black",rgb:"#000","class":"dark"},{name:"White",rgb:"#aaa","class":"stable"},{name:"Green",rgb:"#080","class":"balanced"},{name:"Yellow",rgb:"#880","class":"energized"},{name:"LtBlue",rgb:"#38f","class":"calm"},{name:"Purple",rgb:"#86e","class":"royal"}]}).factory("$lookup",["$http","$q","$token","$localStorage","$log","ENV",function(e,t,n,a,o,i){return{inited:!1,rating:{},period:[],inf:{},cmd:{},cav:{},gun:{},gw:{1:"Fast",2:"Very Mobile",3:"Mobile",4:"Slow",5:"Very Slow and Heavy",6:"Immobile"},forces:{},getPeriod:function(e){var t=null,n=this;return angular.forEach(n.period,function(n){n.code===e&&(t=n)},n),t},describePeriod:function(e){if(""===e||null===e)return"";var t=this.getPeriod(e);return t?t.name+" ... "+t.from+"-"+t.to:""},getForces:function(t){var o=this;e.post(i.SERVER+"/forces",{token:n.get(),period:t}).success(function(e){o.forces=e,a.force=e})},getFlag:function(e){var t=this,n=null;return angular.forEach(t.forces,function(t){t.Nation===e&&(n=t.Flag)},t),n},loadData:function(e){var t=this;angular.forEach(e.Ratings,function(e){t.rating[e.Id]={name:e.Name}},t),t.period=[],angular.forEach(e.Periods,function(e){t.period.push({code:e.Code,name:e.Name,from:e.From,to:e.To,lat:e.Lat,lng:e.Lng})},t),angular.forEach(e.Infs,function(e){t.inf[e.Id]={name:e.Name,desc:e.Desc,bases:e.Bases,ranks:e.Ranks,fire:e.Fire,bayonet:e.Bayonet,shock:e.Shock,rifle:e.Rifle,image:e.Image}},t),angular.forEach(e.Cavs,function(e){t.cav[e.Id]={name:e.Name,cr:e.Cr,sk:e.Sk,lance:e.Lance,scout:e.Scout,cossack:e.Cossack,dismount:e.Dismount,image:e.Image}}),angular.forEach(e.Guns,function(e){t.gun[e.Id]={name:e.Name,desc:e.Desc,calibre:e.Calibre,weight:e.Weight,horse:e.Horse,HW:e.HW,rc:e.Rc,rs:e.Rs,rr:e.Rr,image:e.Image}}),angular.forEach(e.Cmds,function(e){t.cmd[e.Id]={name:e.Name,image:e.Image}}),angular.forEach(e.Forces,function(e){t.force[e.Id]={period:e.Period,nation:e.Nation,inf:e.Inf,div:e.Div,bde:e.Bde,cav:e.Cav,art:e.Art}}),a.lookups=!0,a.rating=t.rating,a.period=t.period,a.inf=t.inf,a.cav=t.cav,a.gun=t.gun,a.cmd=t.cmd,a.force=t.force,this.inited=!0},init:function(){if(!this.inited)if(this.inited=!0,a.lookups)this.rating=a.rating,this.period=a.period,this.inf=a.inf,this.cav=a.cav,this.cmd=a.cmd,this.gun=a.gun,this.force=a.force;else{var r=this,s=t.defer();e.post(i.SERVER+"/lookups",{token:n.get()}).success(function(e){r.loadData(e),s.resolve(e)}).error(function(e,t){o.error("Failed to get Lookups",e,t),s.reject(e)})}}}}]).factory("$battleScenes",function(){return["1","2","3","4","5","6","7","8","9","10","11","hanau","paris","paris-mob","brienne","waterloo","waterloo2","battlefield","bagration","borodino","waterloo3","friedland","russia","wagram","kgl","eylau","ship","jena","guns","guard","russo-turkish1800","russo-iranwar","pyramids","80yw01","rev00","rev01","rev02","rev03","rev04","syw01","syw02","syw03","syw04","syw05","syw06","arcola","nyw02","liberty","nyw01"]}).factory("$scenario",["$log","$icons","$token","$q","$http","$slots","$armies","$localStorage","$lookup","ENV",function(e,t,n,a,o,i,r,s,l,c){return t.init(),{file:{name:"",year:"",season:"",period:"",image:"default"},changed:!1,type:null,level:null,color:null,units:{},HQ:{},Corps:{},objs:[],nextObjId:1,nextUnitId:{},nextCav:"DRG",nextGun:"6lb",oMode:"New",oColor:"GoldObjective",lastObj:null,markers:{},paths:{objPaths:{type:"multiPolyline",color:"#941",opacity:.3,weight:5,layer:"objective",latlngs:[]},gunShortRange:{type:"circle",color:"#f20",weight:3,radius:600,latlngs:{lat:0,lng:0}},gunLongRange:{type:"circle",color:"#f62",weight:3,radius:1800,latlngs:{lat:0,lng:0}}},initScenario:function(){angular.forEach(r,function(e){angular.isUndefined(this.units[e.name])&&(this.units[e.name]=[]),angular.isUndefined(this.paths[e.name])&&(this.paths[e.name]={type:"multiPolyline",color:e.rgb,opacity:.4,weight:4,layer:"strategic",latlngs:[]})},this),this.newScenario()},newScenario:function(){this.markers={},angular.forEach(r,function(e){this.units[e.name]=[],this.paths[e.name].latlngs=[],this.nextUnitId[e.name]=1},this),this.objs=[],this.paths.objPaths.latlngs=[]},createScenario:function(e){this.initScenario(),this.file.name=e.name,this.file.period=e.period,this.file.year=e.year,this.file.season=e.season},getArmy:function(){var e=null,t=this.color;return t&&angular.forEach(r,function(n){n.name==t&&(e=n)}),e},setSelection:function(e,t){this.color=e,this.level=t},clearSelection:function(){angular.forEach(this.colors,function(e,t){this.HQ[t]=this.Corps[t]=null},this),this.lvl=0},objMode:function(e,t){this.oMode=e,this.oColor=t,this.lastObj=null},addUnit:function(e,n,a,o){angular.isUndefined(this.units[e])&&this.initScenario();var i=this.nextUnitId[e],r=e+i;this.nextUnitId[e]++;var s="tactical";switch(n){case"HQ":case"Corps":s="strategic"}var c={type:"U",lvl:n,icon:t[e][n],lat:a,lng:o,focus:!1,draggable:!0,layer:s,color:e,id:r,parent:null,label:{message:e+" Force #"+i,options:{noHide:!0,offset:[2,2],opacity:.9}}},u=null;switch(n){case"HQ":this.HQ[e]=r,c.parent=null,this.level="Corps";break;case"Corps":c.cmd="",c.skill="5",c.logistics="50",c.vigour="50",c.initiative="50",this.Corps[e]=r,c.parent=this.HQ[e],u=this.markers[c.parent],c.nation=u.nation;break;case"Div":c.cmd="",c.skill="5",c.vigour="50",c.parent=this.Corps[e],c.parent&&(u=this.markers[c.parent],c.skill=u.skill,c.vigour=u.vigour,c.nation=u.nation),c.sub=[],angular.forEach(l.forces,function(e){e.Period===this.file.period&&e.Nation===c.nation&&angular.copy(e.Div,c.sub)},this);break;case"Bde":c.cmd="",c.skill="5",c.vigour="50",c.parent=this.Corps[e],c.parent&&(u=this.markers[c.parent],c.skill=u.skill,c.vigour=u.vigour,c.nation=u.nation),c.sub=[],angular.forEach(l.forces,function(e){e.Period===this.file.period&&e.Nation===c.nation&&angular.copy(e.Bde,c.sub)},this);break;case"Gun":c.cmd="",c.skill="5",c.logistics="50",c.guns=this.nextGun,c.parent=this.Corps[e],c.parent&&(u=this.markers[c.parent],c.skill=u.skill,c.logistics=u.logistics,c.nation=u.nation),c.sub=[],angular.forEach(l.forces,function(e){e.Period===this.file.period&&e.Nation===c.nation&&angular.copy(e.Art,c.sub)},this);break;case"Cav":c.cmd="",c.skill="5",c.initiative="50",c.cav=this.nextCav,c.parent=this.Corps[e],c.parent&&(u=this.markers[c.parent],c.skill=u.skill,c.initiative=u.initiative,c.nation=u.nation),c.sub=[],angular.forEach(l.forces,function(e){e.Period===this.file.period&&e.Nation===c.nation&&angular.copy(e.Cav,c.sub)},this)}if(this._matchRangeMarker(c),this.units[e].push(c),this.markers[c.id]=c,c.parent){var g=[this.markers[c.id],this.markers[c.parent]];this.paths[e].latlngs.push(g)}return this.changed=!0,c},addObjective:function(e,n,a){var o=this.nextObjId;this.nextObjId++;var i={type:"O",icon:t[e],lat:n,lng:a,focus:!1,draggable:!0,opacity:.6,layer:"objective",color:e,id:o,connections:[],name:"Objective #"+o
};return this.objs.push(i),this.lastObj=i,this.markers["O"+o]=i,this.changed=!0,i},dragObjective:function(e,t){e.lat=t.lat,e.lng=t.lng,this.changed=!0},dragUnit:function(e,t){this._matchRangeMarker(e),this.paths.gunShortRange.latlngs=t,this.paths.gunLongRange.latlngs=t,e.lat=t.lat,e.lng=t.lng,this.getParentDistance(e),this.changed=!0},_hideRangeMarker:function(){this.paths.gunShortRange.latlngs=[0,0],this.paths.gunLongRange.latlngs=[0,0],this.paths.gunShortRange.radius=200,this.paths.gunLongRange.radius=600},_matchRangeMarker:function(e){switch(this.paths.gunShortRange.latlngs=e,this.paths.gunLongRange.latlngs=e,e.lvl){case"HQ":case"Corps":this.paths.gunShortRange.radius=200,this.paths.gunLongRange.radius=600;break;case"Div":this.paths.gunShortRange.radius=200,this.paths.gunLongRange.radius=1200;break;case"Bde":case"Cav":this.paths.gunShortRange.radius=200,this.paths.gunLongRange.radius=800;break;case"Gun":switch(e.guns){case"12lb":this.paths.gunShortRange.radius=600,this.paths.gunLongRange.radius=1800;break;case"6lb":this.paths.gunShortRange.radius=400,this.paths.gunLongRange.radius=1200;break;case"HW":this.paths.gunShortRange.radius=200,this.paths.gunLongRange.radius=1600}}},click:function(e){switch(e.type){case"U":switch(this.color=e.color,this._matchRangeMarker(e),this.getParentDistance(e),e.lvl){case"HQ":this.HQ[e.color]=e.id;break;case"Corps":this.Corps[e.color]=e.id;break;case"Gun":this.nextGun=e.guns;break;case"Cav":this.nextCav=e.cav}break;case"O":switch(this.oMode){case"Del":this.deleteObj(e),this.oMode="New";break;case"Connect":this.lastObj&&this.connectObj(e,this.lastObj),this.lastObj=e}}},connectObj:function(e,t){var n=e.id,a=t.id;if(n!=a){var o=!0;angular.forEach(e.connections,function(e){e==a&&(o=!1)}),o&&(e.connections.push(a),t.connections.push(n),this.generateObjPaths(),this.changed=!0)}},deleteUnit:function(e){var t=this;angular.forEach(this.markers,function(n){n.parent===e.id&&t.deleteUnit(n)});var n=this.units[e.color].indexOf(e);if(!(0>n)){this.units[e.color].splice(n,1),delete this.markers[e.id];for(var a=this.paths[e.color].latlngs,o=0;o<a.length;o++)a[o][0]==e&&(a.splice(o,1),o--);this.changed=!0,this._hideRangeMarker()}},deleteObj:function(e){var t=this.objs.indexOf(e);if(!(0>t)){this.objs.splice(t,1),delete this.markers["O"+e.id];for(var n=this.paths.objPaths.latlngs,a=0;a<n.length;a++)(n[a][0]==e||n[a][1]==e)&&(n.splice(a,1),a--);this.changed=!0}},disconnectObjective:function(e){e.connections=[],angular.forEach(this.objs,function(t){for(var n=0;n<t.connections.length;n++)t.connections[n]==e.id&&(t.connections.splice(n,1),n--)},this),this.generateObjPaths(),this.changed=!0},_findObjById:function(e){var t;for(t=0;t<this.objs.length;t++)if(this.objs[t].id==e)return t;return-1},generateObjPaths:function(){var e=[];angular.forEach(this.objs,function(t){angular.forEach(t.connections,function(n){var a=this._findObjById(n);e.push([t,this.objs[a]])},this)},this),this.paths.objPaths.latlngs=e},convertUnitToSave:function(e){var t={lat:e.lat,lng:e.lng,name:e.label.message,lvl:e.lvl,id:e.id,parent:e.parent,nation:e.nation};switch(e.lvl){case"HQ":break;case"Corps":t.cmd=e.cmd,t.skill=e.skill,t.logistics=e.logistics,t.initiative=e.initiative,t.vigour=e.vigour;break;case"Div":case"Bde":t.cmd=e.cmd,t.skill=e.skill,t.vigour=e.vigour,t.sub=e.sub;break;case"Gun":t.cmd=e.cmd,t.skill=e.skill,t.logistics=e.logistics,t.guns=e.guns,t.sub=e.sub;break;case"Cav":t.cmd=e.cmd,t.skill=e.skill,t.initiative=e.initiative,t.cav=e.cav,t.sub=e.sub}return t},convertUnitFromSave:function(e,n){var a="tactical";switch(n.lvl){case"HQ":case"Corps":a="strategic"}var o={type:"U",lvl:n.lvl,color:e,lat:n.lat,lng:n.lng,id:n.id,nation:n.nation,parent:n.parent,icon:t[e][n.lvl],focus:!1,draggable:!0,layer:a,label:{message:n.name,options:{noHide:!0,offset:[2,2],opacity:.9}}};switch(this.getParentDistance(o),o.lvl){case"HQ":break;case"Corps":o.cmd=n.cmd,o.skill=n.skill,o.logistics=n.logistics,o.initiative=n.initiative,o.vigour=n.vigour;break;case"Div":case"Bde":o.cmd=n.cmd,o.skill=n.skill,o.vigour=n.vigour,o.sub=n.sub;break;case"Gun":o.cmd=n.cmd,o.skill=n.skill,o.logistics=n.logistics,o.guns=n.guns,o.sub=n.sub;break;case"Cav":o.cmd=n.cmd,o.skill=n.skill,o.initiative=n.initiative,o.cav=n.cav,o.sub=n.sub}return o},convertObjToSave:function(e){return{id:e.id,lat:e.lat,lng:e.lng,name:e.name,color:e.color,connect:e.connections}},convertObjFromSave:function(e){return{type:"O",icon:t[e.color],id:e.id,lat:e.lat,lng:e.lng,name:e.name,color:e.color,connections:e.connect,focus:!1,draggable:!0,opacity:.6,layer:"objective"}},deleteSlot:function(t){var r={token:n.get(),Slot:t},s=a.defer();return o.post(c.SERVER+"/deletemap",r).success(function(t,n){e.info("Delete Slot",t,n),i.load(),s.resolve(n)}).error(function(t,n){e.info("Delete Slot Error",t,n),s.reject(n)}),this.changed=!0,s.promise},save:function(t,i){var r={},s=[];angular.forEach(this.units,function(e,t){e.length>0&&(r[t]=[],angular.forEach(e,function(e){r[t].push(this.convertUnitToSave(e))},this))},this),angular.forEach(this.objs,function(e){var t=this.convertObjToSave(e);s.push(t)},this);var l={token:n.get(),Slot:t,Name:this.file.name,Season:this.file.season,Year:this.file.year,Period:this.file.period,Image:this.file.image,Lat:i.center.lat,Lng:i.center.lng,Zoom:i.center.zoom,Units:r,Obj:s,NextUnitId:this.nextUnitId,NextObjId:this.nextObjId},u=a.defer();return o.post(c.SERVER+"/savemap",l).success(function(e,t){u.resolve(t)}).error(function(t,n){e.info("Map Save Error",t,n),u.reject(n)}),this.changed=!1,u.promise},saveToLocalStorage:function(e){var t={},n=[];angular.forEach(this.units,function(e,n){e.length>0&&(t[n]=[],angular.forEach(e,function(e){t[n].push(this.convertUnitToSave(e))},this))},this),angular.forEach(this.objs,function(e){var t=this.convertObjToSave(e);n.push(t)},this);var a={Name:e.file.name,Season:this.file.season,Year:this.file.year,Period:this.file.period,Image:this.file.image,Lat:e.center.lat,Lng:e.center.lng,Zoom:e.center.zoom,Units:t,Obj:n,NextUnitId:this.nextUnitId,NextObjId:this.nextObjId};s.scenario=a},load:function(t){var i=a.defer(),r=this;return o.post(c.SERVER+"/loadmap",{token:n.get(),slot:t}).success(function(e){r.file.name=e.Name,r.file.season=e.Season,r.file.year=e.Year,r.file.image=e.Image,r.file.period=e.Period,r.unwind(e),e.markers=r.markers,e.paths=r.paths,i.resolve(e)}).error(function(t,n){e.warn(t,n),i.reject(n)}),this.changed=!1,i.promise},loadFromLocalStorage:function(){var e=s.scenario;return angular.isDefined(e)&&(this.file.name=e.Name,this.file.season=e.Season,this.file.year=e.Year,this.file.period=e.Period,this.image=e.Image,this.unwind(e),e.markers=this.markers,e.paths=this.paths),this.changed=!1,e},unwind:function(e){this.newScenario(),angular.forEach(r,function(t){angular.forEach(e.Units[t.name],function(e){var n=this.convertUnitFromSave(t.name,e);if(this.units[t.name].push(n),this.markers[n.id]=n,n.parent){var a=[this.markers[n.id],this.markers[n.parent]];this.paths[t.name].latlngs.push(a)}},this)},this),angular.forEach(e.Obj,function(e){var t=this.convertObjFromSave(e);this.objs.push(t),this.markers["O"+e.id]=t},this),this.generateObjPaths(),this.nextObjId=e.NextObjId,this.nextUnitId=e.NextUnitId,this.changed=!1},getMarkers:function(){var e=[];return angular.forEach(this.blue,function(t){e.push(t.marker)}),angular.forEach(this.red,function(t){e.push(t.marker)}),e},getParentDistance:function(e){if(e&&e.parent){var t=this.markers[e.parent],n=L.latLng({lat:e.lat,lng:e.lng}),a=L.latLng({lat:t.lat,lng:t.lng}),o=n.distanceTo(a),i=Math.round(o/1e3);e.parentMetres=o,e.parentDistance=i,e.parentDistance=2>i?""+100*Math.round(o/75)+" paces from HQ":5>i?"within a league of HQ":9>i?"a couple of leagues from HQ":19>i?"some "+Math.round((o+2500)/4800)+" leagues from HQ":"about "+Math.round((i+12)/25)+" days march from HQ";var r=Math.round((i+.3)/12);1.5>r?e.courierTime="within the hour by horse":25>i?e.courierTime="up to "+r+" hrs by horse":(r=Math.round(i/6),e.courierTime="up to "+r+" hrs by horse"),2>i&&(e.courierTime="within half an hour by horse"),500>o&&(e.courierTime="within direct contact")}}}}]).factory("$layers",[function(){return{baselayers:{watercolor:{name:"WaterColor",url:"http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.png",type:"xyz"},topographic:{name:"TopoGraphic",url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",type:"xyz"},technical:{name:"Technical",url:"http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png",type:"xyz"}},overlays:{hillshade:{name:"Hillshade Europa",type:"wms",url:"http://129.206.228.72/cached/hillshade",visible:!1,layerOptions:{layers:"europe_wms:hs_srtm_europa",format:"image/png",opacity:.25,attribution:"Hillshade layer by GIScience http://www.osm-wms.de",crs:L.CRS.EPSG900913}},labels:{name:"Labels",url:"http://{s}.tile.stamen.com/toner-labels/{z}/{x}/{y}.png",type:"xyz",visible:!0}}}}]).factory("$tabs",["$ionicTabsDelegate",function(e){return{get:function(t){var n,a=e._instances;return angular.forEach(a,function(e){e.$$delegateHandle===t&&(n=e)}),n},select:function(e,t){var n=this.get(e);void 0!==n&&n.select(t)}}}]).factory("$icons",["$armies",function(e){return{GoldObjective:{iconUrl:"icons/goldObjective.png",iconSize:[64,64],iconAnchor:[32,32]},BlueObjective:{iconUrl:"icons/blueObjective.png",iconSize:[80,80],iconAnchor:[40,40]},RedObjective:{iconUrl:"icons/redObjective.png",iconSize:[96,91],iconAnchor:[48,46]},initialized:!1,icons:{},init:function(){this.initialized||angular.forEach(e,function(e){this[e.name]={},this[e.name].HQ={iconUrl:"icons/"+e.name+"HQ.png",shadowUrl:"icons/shadow.png",iconSize:[64,64],shadowSize:[64,64],iconAnchor:[0,64],shadowAnchor:[0,60]},this[e.name].Corps={iconUrl:"icons/"+e.name+"Corps.png",shadowUrl:"icons/shadow.png",iconSize:[64,64],shadowSize:[64,64],iconAnchor:[0,64],shadowAnchor:[0,60]},this[e.name].Div={iconUrl:"icons/"+e.name+"Div.png",shadowUrl:"icons/shadow.png",iconSize:[48,48],shadowSize:[48,48],iconAnchor:[0,48],shadowAnchor:[0,44]},this[e.name].Bde={iconUrl:"icons/"+e.name+"Bde.png",shadowUrl:"icons/shadow.png",iconSize:[32,32],shadowSize:[32,32],iconAnchor:[0,32],shadowAnchor:[0,30]},this[e.name].Gun={iconUrl:"icons/"+e.name+"Gun.png",shadowUrl:"icons/shadow.png",iconSize:[32,32],shadowSize:[32,32],iconAnchor:[0,32],shadowAnchor:[0,30]},this[e.name].Cav={iconUrl:"icons/"+e.name+"Cav.png",shadowUrl:"icons/shadow.png",iconSize:[32,32],shadowSize:[32,32],iconAnchor:[0,32],shadowAnchor:[0,30]}},this)}}}]);